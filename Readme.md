# Satellite Data Processing Pipeline

This repository contains Python scripts that together form a pipeline for acquiring, processing, and analyzing satellite imagery data about Land Surface Temperature from Sentinel-2 and Sentinel-3 satellites. The pipeline includes:

1. **Data Acquisition Script**: Downloads and preprocesses satellite data (NDVI and LST) for a specified area and time range.
2. **Data Processing Script**: Processes the acquired data to analyze the relationship between NDVI and land surface temperature, and generates visualizations and outputs.

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Data Acquisition](#data-acquisition)
- [Data Processing](#data-processing)
- [Outputs](#outputs)
- [Usage Notes](#usage-notes)
- [Acknowledgments](#acknowledgments)

## Overview

### Data Acquisition Script (`data_acquisition.py`)

This script performs the following tasks:

- Connects to STAC APIs to search and retrieve Sentinel-2 and Sentinel-3 satellite data for a specified geographic area and date range.
- Processes Sentinel-3 data to obtain Land Surface Temperature (LST) and reprojects it to a uniform grid.
- Processes Sentinel-2 data to calculate the Normalized Difference Vegetation Index (NDVI).
- Clips the data to the area of interest and saves the outputs as GeoTIFF files.

### Data Processing Script (`process_satellite_data.py`)

This script:

- Loads the NDVI and LST GeoTIFF files generated by the data acquisition script.
- Performs spatial analysis to explore the relationship between NDVI and LST.
- Generates visualizations including scatter plots, correlation analysis, and side-by-side raster comparisons.
- Saves the results and figures in a specified output directory.

## Prerequisites

- Python 3.7 or higher
- An environment capable of installing and running the required Python libraries.

## Installation

1. **Clone the Repository**

   ```bash
   git clone https://github.com/TIDOP-USAL/LST_S3_10m.git
   cd LST_S3_10m
   ```

2. **Create a Virtual Environment (Optional but Recommended)**

   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows use `venv\Scripts\activate`
   ```

3. **Install the Required Libraries**

   Install the libraries listed in `requirements.txt`:

   ```bash
   pip install -r requirements.txt
   ```

## Data Acquisition

The `data_acquisition.py` script is responsible for downloading and preprocessing satellite data.

### How to Use

1. **Prepare the Area of Interest**

   - Place your area of interest as a GeoJSON file in the `geojson` directory.
   - Update the `area_path` variable in the `process()` function with the path to your GeoJSON file.
   - Ensure the GeoJSON file is in EPSG:4326 coordinate reference system.

2. **Set the Date Range**

   - Modify the `date_ini` and `date_end` variables in the `process()` function to specify the date range for data acquisition.

3. **Run the Script**

   ```bash
   python data_acquisition.py
   ```

### Script Details

- **Imports Required Libraries**: Connects to STAC APIs using `pystac_client` and `planetary_computer`.
- **Defines Helper Functions**:
  - `get_items()`: Searches for satellite data items.
  - `get_data_s3()`: Retrieves and processes Sentinel-3 LST data.
  - `df_to_gdf()`: Converts a DataFrame to a GeoDataFrame.
  - `create_geocube()`: Rasterizes point data onto a grid.
  - `get_area()`: Reads the area of interest from a GeoJSON file.
  - `get_s3()`: Processes Sentinel-3 data and saves the LST raster.
  - `get_s2()`: Processes Sentinel-2 data and saves the NDVI raster.
- **Processes Sentinel-3 Data**: Downloads LST data, reprojects it, and clips it to the area of interest.
- **Processes Sentinel-2 Data**: Downloads multispectral data, calculates NDVI, and clips it to the area of interest.
- **Saves Outputs**: Outputs are saved in the `out_small` directory with filenames indicating the data source and date range.

## Data Processing

The `process_satellite_data.py` script analyzes the relationship between NDVI and LST.

### How to Use

1. **Ensure Data Availability**

   - Run the `data_acquisition.py` script first to generate the necessary NDVI and LST GeoTIFF files.
   - Verify that the output files are in the `out_small` directory.

2. **Configure Output Directory**

   - In the `main()` function, set the `output_dir` variable to your desired output directory (default is `results`).

3. **Run the Script**

   ```bash
   python process_satellite_data.py
   ```

### Script Details

- **Loads Data**: Reads the NDVI and LST GeoTIFF files.
- **Spatial Analysis**:
  - Clips the data to the area of interest.
  - Creates a grid based on the temperature raster.
  - Calculates zonal statistics (mean NDVI and LST) for each grid cell.
- **Data Visualization**:
  - Plots NDVI and LST rasters.
  - Generates scatter plots to analyze the correlation between NDVI and LST.
  - Fits a linear regression model to quantify the relationship.
- **Saves Outputs**: All outputs (figures, CSV files, and GeoTIFFs) are saved in the specified output directory.

## Outputs

After running both scripts, you will find the following outputs:

- **NDVI and LST Rasters**: GeoTIFF files in the `out` directory.
- **Results Directory**: Contains analysis outputs including:
  - `ndvi_temperature_rasters.png`: Plot of NDVI and LST rasters.
  - `area_statistics.csv`: CSV file with zonal statistics.
  - `ndvi_temperature_statistics.png`: Plots of NDVI and LST statistics.
  - `ndvi_temperature_correlation.png`: Scatter plot showing correlation and regression analysis.
  - `ndvi_temp_comparisons.png`: Comparison of NDVI, original LST, and estimated LST.
  - `estimated_temperature.tif`: GeoTIFF of the estimated LST derived from NDVI.

## Usage Notes

- **CRS Consistency**: Ensure that all spatial data (area of interest, satellite data) are in compatible coordinate reference systems.
- **Data Availability**: The scripts fetch the latest available data within the specified date ranges. Data availability may vary.
- **Performance**: Processing large areas or high-resolution data may require significant computational resources.
- **Error Handling**: The scripts assume that data is available and that API requests are successful. Implement additional error handling as needed.

## Acknowledgments

- **Sentinel Satellites**: European Space Agency (ESA) for providing Sentinel-2 and Sentinel-3 data.
- **Planetary Computer**: Microsoft Planetary Computer for access to Sentinel-3 data.
- **Earth Search**: Element 84's Earth Search for access to Sentinel-2 data.

---

# Requirements

Below is the `requirements.txt` file listing all necessary Python libraries to run the scripts:

```txt
fsspec
stackstac
numpy
pandas
xarray
pystac-client
planetary-computer
geopandas
matplotlib
geocube
rasterio
rasterstats
seaborn
scipy
shapely
rioxarray
```

To install the required libraries, run:

```bash
pip install -r requirements.txt
```

---

Feel free to modify the scripts and adapt them to your specific use case. If you encounter any issues or have questions, please open an issue in the repository or contact the maintainer.